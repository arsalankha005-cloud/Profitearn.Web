<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>User — Investment Dashboard</title>
<style>
 :root{--bg:#071923;--card:#0f2630;--accent:#13b66d;--muted:#9fb3ad}
 *{box-sizing:border-box}
 body{margin:0;font-family:Inter,Arial,Helvetica;background:linear-gradient(180deg,#071923,#041319);color:#eaf7ef}
 header{padding:12px 18px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:transparent;z-index:10}
 h1{margin:0;color:var(--accent)}
 .balance{background:#00140b;color:#9ff6b8;border:2px solid #0ff77f;padding:8px 12px;border-radius:10px;font-weight:700}
 nav{display:flex;gap:8px;justify-content:center;padding:10px;background:transparent}
 nav button{background:var(--accent);border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:700}
 main{max-width:1100px;margin:14px auto;padding:0 12px}
 .plans{display:flex;flex-direction:column;gap:18px;margin-top:12px}
 .plan{background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(0,0,0,0.12));border:1px solid rgba(0,0,0,0.45);border-radius:14px;padding:20px;display:flex;gap:18px;box-shadow:0 18px 40px rgba(3,12,15,0.7)}
 .plan-left{width:160px;text-align:center}
 .price{font-weight:900;font-size:20px;color:#fff}
 .daily{color:var(--muted);margin-top:6px}
 .plan-body{flex:1}
 .plan-title{color:var(--accent);font-weight:900;font-size:20px;margin:0 0 6px}
 .plan-row{display:flex;justify-content:space-between;color:#cfeee0;margin:6px 0}
 .buy{background:var(--accent);border:none;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:900;color:#022}
 .card{background:var(--card);padding:16px;border-radius:12px;border:1px solid rgba(0,0,0,0.45);margin-top:12px}
 label{display:block;color:var(--muted);margin:8px 0 6px}
 input,select{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.45);background:#071a16;color:#eaf8ee}
 .submit{background:var(--accent);border:none;padding:10px 14px;border-radius:8px;cursor:pointer;color:#022;font-weight:800;margin-top:8px}
 .muted{color:var(--muted)}
 .pending-list{margin-top:12px;display:flex;flex-direction:column;gap:8px}
 .pending-item{background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;display:flex;justify-content:space-between;align-items:center}
 .small-btn{background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.03);padding:6px 8px;border-radius:6px;color:var(--muted);cursor:pointer}
 footer{text-align:center;color:var(--muted);margin:30px 0}
 @media(max-width:900px){ .plan{flex-direction:column}.plan-left{width:100%} }
</style>
</head>
<body>
<header>
  <h1>Investment Dashboard</h1>
  <div class="balance">Balance: Rs <span id="balance">0</span></div>
</header>

<nav>
  <button onclick="show('home')">Home</button>
  <button onclick="show('deposit')">Deposit</button>
  <button onclick="show('withdraw')">Withdraw</button>
  <button onclick="show('ref')">Referral</button>
</nav>

<main>
  <!-- HOME -->
  <section id="home" class="page">
    <h2 style="color:var(--accent)">VIP Plans (30 days)</h2>
    <p class="muted">Large VIP cards. Click Buy Now to prefill deposit and activate plan.</p>
    <div id="plans" class="plans"></div>

    <div class="card" style="margin-top:18px">
      <h3 style="margin:0;color:var(--accent)">Active Plans / Timers</h3>
      <div id="activePlans" style="margin-top:10px" class="muted">No active plans.</div>
    </div>
  </section>

  <!-- DEPOSIT -->
  <section id="deposit" class="page" style="display:none">
    <h2 style="color:var(--accent)">Deposit</h2>
    <div class="card">
      <div style="display:flex;gap:12px;flex-wrap:wrap">
        <div style="flex:1;min-width:200px">
          <strong>JazzCash</strong><div class="muted">Ali Hussain</div>
          <div style="margin-top:6px;font-weight:900">03218684114 <button class="small-btn" onclick="copyText('03218684114')">Copy</button></div>
          <div class="muted" style="font-size:13px;margin-top:6px">Send amount & use Transaction ID in form</div>
        </div>
        <div style="flex:1;min-width:200px">
          <strong>EasyPaisa</strong><div class="muted">Ali Hussain</div>
          <div style="margin-top:6px;font-weight:900">03706502150 <button class="small-btn" onclick="copyText('03706502150')">Copy</button></div>
          <div class="muted" style="font-size:13px;margin-top:6px">Send amount & use Transaction ID in form</div>
        </div>
      </div>

      <label>Payment Method</label>
      <select id="d_method"><option value="jazzcash">JazzCash</option><option value="easypaisa">EasyPaisa</option></select>

      <label>Your Name</label>
      <input id="d_name" type="text" placeholder="Full name">

      <label>Amount (PKR)</label>
      <input id="d_amount" type="number" placeholder="e.g. 1500">

      <label>Transaction ID</label>
      <input id="d_trx" type="text" placeholder="Transaction ID">

      <label>PIN (7890)</label>
      <input id="d_pin" type="password" placeholder="PIN">

      <div style="display:flex;gap:10px;justify-content:flex-end">
        <button class="submit" onclick="submitDeposit()">Submit Deposit Request</button>
      </div>

      <div id="deposit_history" class="muted" style="margin-top:12px"></div>
    </div>
  </section>

  <!-- WITHDRAW -->
  <section id="withdraw" class="page" style="display:none">
    <h2 style="color:var(--accent)">Withdraw</h2>
    <div class="card">
      <label>Method</label>
      <select id="w_method"><option value="jazzcash">JazzCash</option><option value="easypaisa">EasyPaisa</option></select>
      <label>Number</label>
      <input id="w_number" type="text" placeholder="Payout number">
      <label>Amount (PKR)</label>
      <input id="w_amount" type="number" placeholder="Amount to withdraw">
      <div style="display:flex;gap:10px;justify-content:flex-end">
        <button class="submit" onclick="submitWithdraw()">Submit Withdraw Request</button>
      </div>

      <h4 class="muted" style="margin-top:12px">Your Pending Withdraws</h4>
      <div id="pending_withdraws" class="pending-list"></div>
    </div>
  </section>

  <!-- REFERRAL -->
  <section id="ref" class="page" style="display:none">
    <h2 style="color:var(--accent)">Referral Program</h2>
    <div class="card">
      <p class="muted"><strong>Level 1:</strong> 10% &nbsp; <strong>Level 2:</strong> 4% &nbsp; <strong>Level 3:</strong> 1%</p>
      <label>Your referral link (copy)</label>
      <input id="ref_link" readonly />
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
        <button class="submit" onclick="copyRef()">Copy Link</button>
      </div>
      <div class="muted" style="margin-top:12px">Commissions are paid automatically when daily profits are distributed for active plans.</div>
    </div>
  </section>

  <footer>© Demo — Keep files in same folder so admin and user share localStorage</footer>
</main>

<script>
/* ---------------------------
   Storage keys & constants
   --------------------------- */
const KEY_DEPOSITS = 'inv_deposits_v3';
const KEY_WITHDRAWS = 'inv_withdraws_v3';
const KEY_BALANCES = 'inv_balances_v3';
const KEY_USERID = 'inv_userid_v3';
const KEY_PLANS_ACTIVE = 'inv_active_plans_v3'; // active plans per user (list)
const PIN = '7890';
const ONE_HOUR = 3600000;
const ONE_DAY = 24*3600*1000;

/* Plans */
const PLANS = [
 {id:1,name:'Plan 1',price:350,daily:55},
 {id:2,name:'Plan 2',price:720,daily:110},
 {id:3,name:'Plan 3',price:1500,daily:220},
 {id:4,name:'Plan 4',price:4000,daily:440},
 {id:5,name:'Plan 5',price:9000,daily:990},
 {id:6,name:'Plan 6',price:15000,daily:1760}
];

/* helpers */
function storageGet(k,def){ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):def; }catch(e){return def;} }
function storageSet(k,v){ localStorage.setItem(k,JSON.stringify(v)); }

/* user id & referral handling */
let userId = storageGet(KEY_USERID,null);
if(!userId){
  // if URL has ?ref=UID then save referrer mapping for this user
  const urlParams = new URLSearchParams(location.search);
  const ref = urlParams.get('ref');
  userId = 'U'+Math.floor(100000+Math.random()*900000);
  storageSet(KEY_USERID,userId);
  // store referrer if provided
  if(ref){
    const map = storageGet('inv_refmap_v3', {});
    map[userId] = ref;
    storageSet('inv_refmap_v3', map);
  }
}
if(!storageGet(KEY_BALANCES, {})[userId]){
  const b = storageGet(KEY_BALANCES, {});
  b[userId] = 0;
  storageSet(KEY_BALANCES, b);
}

/* UI helpers */
function show(page){
  document.querySelectorAll('.page').forEach(p=>p.style.display='none');
  document.getElementById(page).style.display='block';
}
function updateBalanceUI(){
  const balances = storageGet(KEY_BALANCES, {});
  document.getElementById('balance').innerText = Number(balances[userId]||0).toFixed(0);
}

/* render plans */
function renderPlans(){
  const wrap = document.getElementById('plans');
  wrap.innerHTML = '';
  PLANS.forEach(p=>{
    const total = p.daily*30;
    const div = document.createElement('div');
    div.className = 'plan';
    div.innerHTML = `
      <div style="display:flex;gap:18px;align-items:center">
        <div class="plan-left">
          <div class="price">Rs ${p.price.toLocaleString()}</div>
          <div class="daily">Daily: Rs ${p.daily}</div>
        </div>
        <div class="plan-body">
          <div class="plan-title">${p.name}</div>
          <div class="plan-row"><div>Price</div><div>Rs ${p.price.toLocaleString()}</div></div>
          <div class="plan-row"><div>Daily Profit</div><div>Rs ${p.daily}</div></div>
          <div class="plan-row"><div>Total Profit (30d)</div><div>Rs ${total.toLocaleString()}</div></div>
          <div style="margin-top:10px;text-align:left"><button class="buy" onclick="buyNow(${p.id})">Buy Now</button></div>
        </div>
      </div>
    `;
    wrap.appendChild(div);
  });
}

/* Active plans UI */
function renderActivePlans(){
  const act = storageGet(KEY_PLANS_ACTIVE, []);
  const mine = act.filter(a=>a.userId===userId);
  const el = document.getElementById('activePlans');
  if(mine.length===0){ el.innerText = 'No active plans.'; return; }
  el.innerHTML = mine.map(a=>{
    const plan = PLANS.find(p=>p.id===a.planId);
    const next = new Date(a.nextRun).toLocaleString();
    return `${plan.name} — Daily: Rs ${plan.daily} — Next payout: ${next}`;
  }).join('<br>');
}

/* BUY NOW: create an "active plan entry" and prefill deposit */
function buyNow(planId){
  const plan = PLANS.find(p=>p.id===planId);
  if(!plan) return;
  // prefill deposit form with plan price and name
  document.getElementById('d_amount').value = plan.price;
  document.getElementById('d_name').value = userId + ' - ' + plan.name;
  show('deposit');
  // set hidden temp value so when admin approves deposit we can auto-activate plan
  document.getElementById('d_trx').dataset.prefillPlan = planId;
  setTimeout(()=>document.getElementById('d_trx').focus(),200);
}

/* Deposit: create deposit request (admin approves to add to balance).
   We also carry planId in the deposit object (if prefilled) so admin can approve & auto-activate plan. */
function submitDeposit(){
  const method = document.getElementById('d_method').value;
  const name = document.getElementById('d_name').value.trim();
  const amount = Number(document.getElementById('d_amount').value);
  const trx = document.getElementById('d_trx').value.trim();
  const pin = document.getElementById('d_pin').value.trim();
  if(!name || !amount || !trx){ alert('Please complete all fields'); return; }
  if(pin !== PIN){ alert('Incorrect PIN'); return; }

  const deposits = storageGet(KEY_DEPOSITS, []);
  const planId = document.getElementById('d_trx').dataset.prefillPlan ? Number(document.getElementById('d_trx').dataset.prefillPlan) : null;
  const obj = { id:'D'+Date.now(), userId, method, name, amount, trx, at:Date.now(), status:'pending', planId: planId };
  deposits.push(obj);
  storageSet(KEY_DEPOSITS, deposits);

  // clear fields (keep name if you like)
  document.getElementById('d_trx').value = '';
  document.getElementById('d_pin').value = '';
  delete document.getElementById('d_trx').dataset.prefillPlan;

  alert('Deposit request submitted. Admin must approve to add balance and (if plan) to activate plan.');
  renderDepositHistory();
}

/* show deposit history for current user */
function renderDepositHistory(){
  const deposits = storageGet(KEY_DEPOSITS, []);
  const mine = deposits.filter(d=>d.userId===userId).slice(-6).reverse();
  const el = document.getElementById('deposit_history');
  if(mine.length===0){ el.innerHTML = '<div class="muted">No deposit records.</div>'; return; }
  el.innerHTML = '<strong>Recent deposit requests:</strong><br>' + mine.map(d=>`${d.method.toUpperCase()} • Rs ${d.amount} • ${d.trx} • ${new Date(d.at).toLocaleString()} • ${d.status}`).join('<br>');
}

/* Withdraw: create withdraw request, deduct immediately (pending), auto-return after 1 hour if not processed */
function submitWithdraw(){
  const method = document.getElementById('w_method').value;
  const number = document.getElementById('w_number').value.trim();
  const amount = Number(document.getElementById('w_amount').value);
  if(!number || !amount){ alert('Complete fields'); return; }

  const balances = storageGet(KEY_BALANCES, {});
  const current = Number(balances[userId] || 0);
  if(amount > current){ alert('Insufficient balance'); return; }

  // deduct immediately
  balances[userId] = current - amount;
  storageSet(KEY_BALANCES, balances);

  const withdraws = storageGet(KEY_WITHDRAWS, []);
  const w = { id:'W'+Date.now(), userId, method, number, amount, requestedAt:Date.now(), status:'pending' };
  withdraws.push(w);
  storageSet(KEY_WITHDRAWS, withdraws);

  renderPendingWithdraws();
  updateBalanceUI();
  setTimeout(()=> autoCancelExpiredWithdraws(), 1000); // schedule check
  alert('Withdraw submitted and is pending. If not processed within 1 hour it will be returned automatically.');
  document.getElementById('w_number').value=''; document.getElementById('w_amount').value='';
}

/* Render pending withdraws for this user */
function renderPendingWithdraws(){
  const listEl = document.getElementById('pending_withdraws');
  const withdraws = storageGet(KEY_WITHDRAWS, []).filter(w=>w.userId===userId).slice().reverse();
  if(withdraws.length===0){ listEl.innerHTML = '<div class="muted">No pending withdraws.</div>'; return; }
  listEl.innerHTML = withdraws.map(w=>{
    const elapsed = Math.floor((Date.now()-w.requestedAt)/60000);
    return `<div class="pending-item"><div>Rs ${w.amount} • ${w.method.toUpperCase()} • ${w.number}<div class="muted" style="font-size:12px">${new Date(w.requestedAt).toLocaleString()}</div></div><div><span class="muted">${w.status}</span><div class="muted" style="font-size:12px">${elapsed} min</div></div></div>`;
  }).join('');
}

/* Auto-cancel withdraws older than 1 hour (return to user's balance) */
function autoCancelExpiredWithdraws(){
  const withdraws = storageGet(KEY_WITHDRAWS, []);
  let changed=false;
  const balances = storageGet(KEY_BALANCES, {});
  withdraws.forEach(w=>{
    if(w.status==='pending' && (Date.now()-w.requestedAt) > ONE_HOUR){
      w.status = 'cancelled';
      balances[w.userId] = (balances[w.userId]||0) + Number(w.amount);
      changed = true;
    }
  });
  if(changed){ storageSet(KEY_WITHDRAWS, withdraws); storageSet(KEY_BALANCES, balances); updateBalanceUI(); renderPendingWithdraws(); }
}

/* Referral: setup link & distribution when profit pays */
function setupReferralLink(){
  const linkEl = document.getElementById('ref_link');
  const link = location.origin + location.pathname + '?ref=' + userId;
  linkEl.value = link;
}
function copyRef(){ const el=document.getElementById('ref_link'); el.select(); document.execCommand('copy'); alert('Referral link copied'); }

/* copy numbers */
function copyText(txt){ navigator.clipboard?.writeText(txt).then(()=>alert('Copied: '+txt), ()=>{ alert('Copy failed — select and copy manually'); }); }

/* -------------------------
   Admin actions accessible
   via localStorage (admin panel)
   ------------------------- */

/* Admin will approve deposit: on approve deposit we add amount to user's balance.
   If deposit contained a planId, activating the plan will create an active-plan record for that user.
*/
function admin_approveDepositLocal(depositId){
  const deposits = storageGet(KEY_DEPOSITS, []);
  const idx = deposits.findIndex(d=>d.id===depositId);
  if(idx===-1) return;
  const d = deposits[idx];
  if(d.status !== 'pending'){ return; }
  // add to user balance
  const balances = storageGet(KEY_BALANCES, {});
  balances[d.userId] = (balances[d.userId]||0) + Number(d.amount);
  storageSet(KEY_BALANCES, balances);

  // mark deposit approved
  d.status = 'approved';
  d.processedAt = Date.now();
  deposits[idx] = d;
  storageSet(KEY_DEPOSITS, deposits);

  // if this deposit had planId -> activate the plan for user (create active plan entry)
  if(d.planId){
    activatePlanForUser(d.userId, d.planId);
  }
}

/* Activate plan: create entry in KEY_PLANS_ACTIVE with nextRun = now + 24h */
function activatePlanForUser(uid, planId){
  const plan = PLANS.find(p=>p.id===planId);
  if(!plan) return;
  const active = storageGet(KEY_PLANS_ACTIVE, []);
  // allow multiple same-plan purchases; create unique id
  const rec = { id:'A'+Date.now(), userId: uid, planId: planId, daily: plan.daily, activatedAt: Date.now(), nextRun: Date.now() + ONE_DAY, status:'active' };
  active.push(rec);
  storageSet(KEY_PLANS_ACTIVE, active);
}

/* Run payout check: find active plans whose nextRun <= now -> pay daily profit to user and schedule nextRun += 24h.
   Also distribute referral commissions up-to-3-levels.
*/
function runPayouts(){
  const active = storageGet(KEY_PLANS_ACTIVE, []);
  if(active.length===0) return;
  const balances = storageGet(KEY_BALANCES, {});
  const refmap = storageGet('inv_refmap_v3', {});
  let changed=false;
  active.forEach(a=>{
    if(a.status==='active' && Date.now() >= a.nextRun){
      // pay daily profit to user
      balances[a.userId] = (balances[a.userId]||0) + Number(a.daily);
      // distribute referral commissions
      // Level1 10%, L2 4%, L3 1% of daily profit
      const lvlPercent = [0.10, 0.04, 0.01];
      let parent = refmap[a.userId];
      for(let level=0; level<3 && parent; level++){
        if(!balances[parent]) balances[parent] = 0;
        const commission = Math.round(Number(a.daily) * lvlPercent[level]);
        if(commission>0){
          balances[parent] = balances[parent] + commission;
        }
        // go up chain
        parent = refmap[parent];
      }
      // schedule next run
      a.nextRun = a.nextRun + ONE_DAY;
      changed = true;
    }
  });
  if(changed){ storageSet(KEY_BALANCES, balances); storageSet(KEY_PLANS_ACTIVE, active); updateBalanceUI(); renderActivePlans(); }
}

/* Periodic runner */
setInterval(()=>{ runPayouts(); autoCancelExpiredWithdraws(); }, 30*1000);

/* Helpers for admin panel (exposed through localStorage actions) */
window.__admin = {
  approveDeposit: admin_approveDepositLocal,
  activatePlanForUser: activatePlanForUser,
  runPayouts: runPayouts
};

/* initial render */
function init(){
  renderPlans();
  updateBalanceUI();
  renderDepositHistory();
  renderPendingWithdraws();
  renderActivePlans();
  setupReferralLink();
  // on load run payout logic once to pick up any due items
  runPayouts();
  autoCancelExpiredWithdraws();
}
window.addEventListener('load', init);

/* Expose navigation functions to buttons */
window.show = show;
window.buyNow = buyNow;
window.submitDeposit = submitDeposit;
window.submitWithdraw = submitWithdraw;
window.copyText = copyText;
window.copyRef = copyRef;
</script>
</body>
</html>
